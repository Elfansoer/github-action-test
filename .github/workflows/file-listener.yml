name: Listener
run-name: A listener by @${{ github.actor }}
on:
  push:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron:  '0 0 * * *'

jobs:
  my_first_job:
    name: My first job
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
        with:
            path: 'repo'

      - name: Install Lua/LuaJIT
        # You may pin to the exact commit or the version.
        # uses: leafo/gh-actions-lua@d84e7d61946edb679210088bc1378c099fde51fe
        uses: leafo/gh-actions-lua@v9.1.0
        with:
          # The version of Lua to install, must be available on https://www.lua.org/ftp/ or http://luajit.org/download.html
          luaVersion: 5.1

      - name: See the workspace
        run: ls

      - name: Try cd the workspace repo
        run: |
          cd repo
          ls

      - name: Set environment
        run: echo LUA_PATH=${{ github.workspace }}/repo/lua/?.lua >> $GITHUB_ENV

      - name: Check environment
        run: echo $LUA_PATH

      - name: Try lua command
        run: lua ${{ github.workspace }}/repo/lua/main.lua

      - name: Fetch release version
        run: |
          cd repo
          curl -sL https://api.github.com/repos/SteamDatabase/GameTracking-Dota2/commits?PATH=game/dota/pak01_dir/scripts/items/items_game.txt | \
          jq -r ".[0] | .sha" > test.txt

      - name: Check for modified files
        id: git-check
        run: |
          cd repo
          echo modified=$([ -z "`git status --porcelain`" ] && echo "false" || echo "true") >> $GITHUB_OUTPUT

      - name: Show status
        run: |
          cd repo
          echo Comparison is ${{ steps.git-check.outputs.modified }}, result in boolean X${{steps.git-check.outputs.modified=='true'}}X X${{contains(steps.git-check.outputs.modified,'true')}}X

      - name: Download items_game.txt
        if: ${{ steps.git-check.outputs.modified == 'true' }} 
        run: |
          cd repo
          curl -sL https://raw.githubusercontent.com/SteamDatabase/GameTracking-Dota2/master/game/dota/pak01_dir/scripts/items/items_game.txt > items_game.txt

      - name: Download npc_heroes.txt
        if: ${{ steps.git-check.outputs.modified == 'true' }} 
        run: |
          cd repo
          curl -sL https://raw.githubusercontent.com/SteamDatabase/GameTracking-Dota2/master/game/dota/pak01_dir/scripts/npc/npc_heroes.txt > npc_heroes.txt

      - name: Check the workspace repo
        if: ${{ steps.git-check.outputs.modified == 'true' }} 
        run: |
          cd repo
          ls

      - name: Commit latest release version
        uses: EndBug/add-and-commit@v9
        with:
          message: 'Add the very useful text file'
          cwd: 'repo'

#       - name: Commit latest release version
#         if: ${{ steps.git-check.outputs.modified == 'true' }} 
#         run: |
#           cd repo
#           git config --global user.name 'Test'
#           git config --global user.email 'test-email@users.noreply.github.com'
#           git commit -am "autoupdate at $(date +%Y-%m-%d-%H:%M)"
#           git push

#   my_second_job:
#     name: My second job
#     needs: my_first_job
